<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Obesity Simulation - Competitive Catabolism</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Toggle switch container */
        .toggle-container {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Toggle switch - pill style */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            cursor: pointer;
            user-select: none;
            border-radius: 20px;
            overflow: hidden;
            background-color: #e2e8f0;
            border: 2px solid #cbd5e1;
        }
        
        .toggle-switch input[type="checkbox"] {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }
        
        .toggle-switch input:disabled ~ .toggle-pill {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toggle-pill {
            display: flex;
            height: 32px;
        }
        
        .toggle-label-left,
        .toggle-label-right {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            min-width: 60px;
        }
        
        /* Left option (unchecked state) */
        .toggle-switch input:not(:checked) ~ .toggle-pill .toggle-label-left {
            background-color: #0891b2;
            color: white;
        }
        
        .toggle-switch input:not(:checked) ~ .toggle-pill .toggle-label-right {
            background-color: transparent;
            color: #64748b;
        }
        
        /* Right option (checked state) */
        .toggle-switch input:checked ~ .toggle-pill .toggle-label-left {
            background-color: transparent;
            color: #64748b;
        }
        
        .toggle-switch input:checked ~ .toggle-pill .toggle-label-right {
            background-color: #0891b2;
            color: white;
        }
        
        /* Hover effects */
        .toggle-switch:hover .toggle-label-left,
        .toggle-switch:hover .toggle-label-right {
            opacity: 0.9;
        }
        
        .toggle-note {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
            user-select: none;
        }
        
        /* Make toggles responsive */
        @media (max-width: 500px) {
            .toggle-container {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Obesity Simulation</h1>
        <p>Metabolic Effects of Adiposity with NHANES Data Comparison</p>
        <a href="/" class="btn-secondary">← Back to Home</a>
    </header>
    
    <div class="container">
        <div class="simulation-layout">
            <div class="controls-panel">
                <h2>Simulation Parameters</h2>
                
                <button id="run-btn" class="btn-primary" style="margin-bottom: 20px; width: 100%;">Run Simulation</button>
                
                <div class="toggle-container">
                    <div class="toggle-group">
                        <span style="font-weight: 500; color: #1e293b; font-size: 14px; user-select: none;">Species</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="species-toggle" checked>
                            <div class="toggle-pill">
                                <span class="toggle-label-left">Mouse</span>
                                <span class="toggle-label-right">Human</span>
                            </div>
                        </label>
                    </div>
                    
                    <div class="toggle-group">
                        <span style="font-weight: 500; color: #1e293b; font-size: 14px; user-select: none;">Sex</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sex-toggle">
                            <div class="toggle-pill">
                                <span class="toggle-label-left">Male</span>
                                <span class="toggle-label-right">Female</span>
                            </div>
                        </label>
                        <small class="toggle-note" id="sex-note">Only applies to human data</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="show-data" checked style="margin-right: 8px;">
                        Show experimental data overlay
                    </label>
                </div>
                
                <h3>Optional Perturbation (shown as dashed line)</h3>
                
                <div class="form-group">
                    <label for="perturbation_param">Perturbation Parameter <a href="/parameters" style="color: #0891b2; font-size: 0.9em; font-weight: normal; text-decoration: none; border-bottom: 1px dotted #0891b2; transition: color 0.2s, border-color 0.2s;" onmouseover="this.style.color='#0e7490'; this.style.borderColor='#0e7490';" onmouseout="this.style.color='#0891b2'; this.style.borderColor='#0891b2';">(learn more)</a></label>
                    <select id="perturbation_param">
                        <option value="">None</option>
                        {% for param in parameter_names %}
                        <option value="{{ param }}">{{ parameter_descriptions.get(param, param) }} ({{ parameter_latex.get(param, param) }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="perturbation_value">Perturbation Value (fold change)</label>
                    <input type="number" id="perturbation_value" value="1.0" min="0" max="5" step="0.1">
                    <small>0 = complete knockout, 1 = no change, 2 = double</small>
                    <small>Parameters labled on/off only accept 1 or 0 </small>
                </div>
                
                <h3>Additional Parameter Modifications (Optional)</h3>
                <div id="additional-params"></div>
                <button id="add-param-btn" class="btn-secondary">+ Add Parameter</button>
            </div>
            
            <div class="results-panel">
                <h2>Simulation Results</h2>
                <div id="error-msg" class="error-msg" style="display: none;"></div>
                <div id="results">
                    <p class="placeholder">Configure parameters and click "Run Simulation" to see results.</p>
                </div>
                <div id="plot-container" style="display: none;">
                    <div id="plots-grid" class="plots-grid"></div>
                    <p class="info-text" id="data-note">
                        <strong>Note:</strong> Simulation results (solid lines) show model predictions.
                        When data overlay is enabled, mouse data from BXD strains (scatter points) or human NHANES data 
                        (line with shaded area showing median and interquartile range by deciles of body fat percentage) 
                        are shown for comparison. Dashed orange lines show perturbed conditions.
                    </p>
                    <button id="download-btn" class="btn-secondary" style="margin-top: 20px;">Download Data (CSV)</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let simulationData = null;
        
        document.getElementById('add-param-btn').addEventListener('click', function() {
            const container = document.getElementById('additional-params');
            const paramDiv = document.createElement('div');
            paramDiv.className = 'param-row';
            paramDiv.innerHTML = `
                <select class="param-name">
                    {% for param in parameter_names %}
                    <option value="{{ param }}">{{ parameter_descriptions.get(param, param) }} ({{ parameter_latex.get(param, param) }})</option>
                    {% endfor %}
                </select>
                <input type="number" class="param-value" step="0.1" value="1.0">
                <button class="btn-remove" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(paramDiv);
        });
        
        async function runSimulation() {
            const species = document.getElementById('species-toggle').checked ? 'human' : 'mouse';
            const sex = document.getElementById('sex-toggle').checked ? 'female' : 'male';
            const showData = document.getElementById('show-data').checked;
            const perturbationParam = document.getElementById('perturbation_param').value;
            const perturbationValue = document.getElementById('perturbation_value').value;
            
            const additionalParams = {};
            document.querySelectorAll('.param-row').forEach(row => {
                const name = row.querySelector('.param-name').value;
                const value = row.querySelector('.param-value').value;
                additionalParams[name] = parseFloat(value);
            });
            
            const data = {
                species: species,
                sex: sex,
                show_data: showData,
                perturbation_param: perturbationParam || null,
                perturbation_value: parseFloat(perturbationValue),
                parameters: additionalParams
            };
            
            // Update button state
            const runBtn = document.getElementById('run-btn');
            const originalText = runBtn.textContent;
            runBtn.textContent = 'Running Simulation...';
            runBtn.disabled = true;
            runBtn.style.filter = 'blur(1px)';
            runBtn.style.opacity = '0.6';
            document.getElementById('error-msg').style.display = 'none';
            
            try {
                const response = await fetch('/api/run_obesity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('results').innerHTML = '';
                    document.getElementById('plot-container').style.display = 'block';
                    
                    const plotsGrid = document.getElementById('plots-grid');
                    plotsGrid.innerHTML = '';
                    
                    // Display warnings if any
                    if (result.warnings && result.warnings.length > 0) {
                        const warningDiv = document.createElement('div');
                        warningDiv.style.cssText = 'background-color: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; word-wrap: break-word; overflow-wrap: break-word;';
                        warningDiv.innerHTML = '<strong style="color: #92400e; font-size: 16px;">⚠️ Simulation Warnings:</strong><ul style="margin: 10px 0 0 0; padding-left: 20px; word-break: break-word;">' + 
                            result.warnings.map(w => `<li style="color: #92400e; margin: 5px 0; word-wrap: break-word;">${w}</li>`).join('') + 
                            '</ul>';
                        plotsGrid.appendChild(warningDiv);
                    }
                    
                    // Add each plot to the grid (CSS handles layout)
                    result.plots.forEach(plot => {
                        const plotDiv = document.createElement('div');
                        plotDiv.className = 'plot-item';
                        plotDiv.innerHTML = plot.data;
                        plotsGrid.appendChild(plotDiv);
                    });
                    
                    simulationData = result.data;
                } else {
                    document.getElementById('error-msg').textContent = 'Error: ' + result.error;
                    document.getElementById('error-msg').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('error-msg').textContent = 'Error: ' + error.message;
                document.getElementById('error-msg').style.display = 'block';
            } finally {
                // Reset button state
                runBtn.textContent = originalText;
                runBtn.disabled = false;
                runBtn.style.filter = 'none';
                runBtn.style.opacity = '1';
            }
        }
        
        document.getElementById('run-btn').addEventListener('click', runSimulation);
        
        // Update sex toggle state based on species selection
        function updateSexToggleState() {
            const speciesToggle = document.getElementById('species-toggle');
            const sexToggle = document.getElementById('sex-toggle');
            const sexNote = document.getElementById('sex-note');
            
            if (!speciesToggle.checked) {  // Mouse is selected
                sexToggle.disabled = true;
                sexToggle.parentElement.style.opacity = '0.5';
                sexToggle.parentElement.style.cursor = 'not-allowed';
                sexNote.style.color = '#94a3b8';
            } else {  // Human is selected
                sexToggle.disabled = false;
                sexToggle.parentElement.style.opacity = '1';
                sexToggle.parentElement.style.cursor = 'pointer';
                sexNote.style.color = '#0891b2';
            }
        }
        
        // Add event listener to species toggle
        document.getElementById('species-toggle').addEventListener('change', updateSexToggleState);
        
        // Initialize state on load
        updateSexToggleState();
        
        // Run default simulation on page load
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('results').innerHTML = '<p class="placeholder">Loading default simulation...</p>';
            runSimulation();
        });
        
        document.getElementById('download-btn').addEventListener('click', function() {
            if (simulationData) {
                const blob = new Blob([simulationData], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'obesity_simulation_results.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }
        });
    </script>
    
    <footer class="site-footer">
        <p>&copy; 2025 Competitive Catabolism Project. Licensed under Apache License 2.0.</p>
        <div class="footer-links">
            <a href="/about">About</a>
            <a href="/privacy">Privacy Policy</a>
            <a href="/terms">Terms of Service</a>
        </div>
    </footer>
</body>
</html>
